#!/bin/bash

if [ -d "node_modules" ]; then
    rm -r node_modules
    REMOVE_PACKAGE_LOCK=true
fi

if [ -f "package-lock.json" ] && [ "$REMOVE_PACKAGE_LOCK" = true ]; then
    rm package-lock.json
fi

npm install

SFDX_PLUGINS=$(cat ./config/dev-config.json | jq -r '.sfdxPlugins[]')

if [[ ! -z "${SFDX_PLUGINS// }" ]]; then
    mkdir -p $HOME/.config/sfdx
    pushd .
    cd $HOME/.config/sfdx
    cat /workspaces/octoforce-actions/config/dev-config.json | jq -r '.sfdxPlugins' > unsignedPluginAllowList.json
    popd
    sfdx plugins:install $SFDX_PLUGINS
fi

npm install --save-dev prettier prettier-plugin-apex lint-staged husky

exit